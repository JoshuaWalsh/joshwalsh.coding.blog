<!DOCTYPE html><html><head><title>joshwalsh.coding.blog | One-day build: Immersive animated lyrics webapp</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/blog.coding.joshwalsh/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/blog.coding.joshwalsh/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/blog.coding.joshwalsh/bundle/codedoc-bundle.js"></script><script>window.githubConfig={"repo":"joshwalsh.coding.blog","user":"JoshuaWalsh"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="joshwalsh.coding.blog | One-day build: Immersive animated lyrics webapp"><meta property="og:type" content="article"><meta property="og:title" content="joshwalsh.coding.blog | One-day build: Immersive animated lyrics webapp"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><div class="header-0-0-4"><a class="watermark-0-0-3" href="https://coding.blog" target="_blank"><svg viewBox="0 0 701 443" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="coding.blog" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-162.000000, -246.000000)" id="Shape"><path d="M538.081948,246.348452 L538.52402,246.445719 L538.52402,246.445719 L538.85529,246.526578 L538.85529,246.526578 L600.956012,263.165455 C602.767076,263.660918 604.526214,264.465865 606.146589,265.591976 C611.80881,269.527048 614.090389,276.211909 612.345003,282.123825 L538.2641,559.728905 C537.816127,561.562539 536.989561,563.335054 535.765607,564.944016 C530.70443,571.597248 520.764856,572.934442 513.564947,567.930724 C507.902727,563.995652 505.621148,557.310791 507.366534,551.398875 L577.145082,289.91439 L546.233523,281.631663 L462.305576,595.917544 L468.439004,634.645619 L493.907962,603.194573 C499.468987,596.327279 509.54413,595.268339 516.411424,600.829364 C523.278717,606.390389 524.337658,616.465532 518.776633,623.332826 L470.948283,682.395919 C466.887248,687.410879 460.418878,689.3283 454.55045,687.832105 L454.212574,687.741996 C448.224449,686.200133 443.421088,681.240355 442.392221,674.744345 L430.503202,599.680031 C430.418831,599.147339 430.361793,598.616628 430.331048,598.089327 C429.783912,595.705405 429.838457,593.220092 430.535776,590.858154 L519.361965,258.223717 L519.447729,257.889555 L519.447729,257.889555 L519.532157,257.586199 L519.627058,257.23399 C520.074771,255.398716 520.901697,253.624577 522.126677,252.014264 C525.828762,247.147643 532.141006,245.125338 538.081948,246.348452 Z M632.156421,656.157784 C640.992977,656.157784 648.156421,663.321228 648.156421,672.157784 C648.156421,680.99434 640.992977,688.157784 632.156421,688.157784 L528.156421,688.157784 C519.319865,688.157784 512.156421,680.99434 512.156421,672.157784 C512.156421,663.321228 519.319865,656.157784 528.156421,656.157784 L632.156421,656.157784 Z M699.234631,342.452157 L857.62655,500.844076 C863.874939,507.092464 863.874939,517.223104 857.62655,523.471493 L699.234631,681.863412 C692.986243,688.1118 682.855603,688.1118 676.607214,681.863412 C670.358826,675.615023 670.358826,665.484383 676.607214,659.235995 L823.686132,512.157077 L676.607214,365.079574 C670.358826,358.831185 670.358826,348.700545 676.607214,342.452157 C682.855603,336.203768 692.986243,336.203768 699.234631,342.452157 Z M347.705627,342.452157 C353.954016,348.700545 353.954016,358.831185 347.705627,365.079574 L200.62671,512.158491 L347.705627,659.235995 C353.954016,665.484383 353.954016,675.615023 347.705627,681.863412 C341.457239,688.1118 331.326599,688.1118 325.07821,681.863412 L166.686292,523.471493 C160.437903,517.223104 160.437903,507.092464 166.686292,500.844076 L325.07821,342.452157 C331.326599,336.203768 341.457239,336.203768 347.705627,342.452157 Z"></path></g></g></svg></a></div><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"lyrics-2.md","namespace":"/blog.coding.joshwalsh","title":{"base":"joshwalsh.coding.blog","connector":" | "}}</script><div class="hero-0-0-10" style="margin-bottom: -96px"><img src="/blog.coding.joshwalsh/img/etoile-banner.jpg" class="image-0-0-11" data-hero=""><span class="caption-0-0-12"></span></div><h1 class="h-0-0-13 white"><span style=" 
      text-shadow: 0 0 8px black; 
      font-size: 48px"><p>One-day build: Immersive animated lyrics webapp</p></span></h1><script id="GcDIQsREgG">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("GcDIQsREgG", "uU5Mf6hX80XLVyK7wxWrHg==", {"src":"github"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><marker><br>

</marker><p>In this post I'll be talking about a project I challenged myself to complete within a single day.</p><p>This post is part of a 3 part series. It will make more sense if you read <a href="/blog.coding.joshwalsh/lyrics-1/">the first post</a> first.</p><p>Some people like to see the finished product first. If this is you, you can see this project in action at <a href="http://sandbox.ymindustries.com/etoile-et-toi/">sandbox.ymindustries.com/etoile-et-toi</a>. If you prefer the suspense, read on, I've put another link near the end of the post.</p><p><em><strong>SYNDICATED CONTENT:</strong> This post originally appeared on blog.joshwalsh.me. You can find the original <a href="https://blog.joshwalsh.me/lyrics-2/">here</a>. Some formatting and content has been removed in order to fit the <code>coding.blog</code> platform.</em></p><hr><h1 id="reincarnation" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Reincarnation</h1><p>It turns out that my fascination for timestamped lyrics has not decreased. I discovered this after I finished watching <em>Kizumonogatari Ⅲ: Reiketsu-hen</em> (Wound Story 3: Cold Blood) and the end credits started rolling.</p><p><img src="/blog.coding.joshwalsh/img/tactical-etoile.gif" alt="Kizumonogatari Ⅲ Credits"></p><p>During the credits a song called <em>étoile et toi (edition le blanc)</em> plays. The lyrics are in French, but Tactical's fansubs kindly provide a translation. The song was very fitting for the movie, but I'm sure that without the translation it wouldn't have resonated with me to such a degree. I found myself listening to the song repeatedly for the next few days, but each time I would have to skip to the end of the movie so I could enjoy the translated lyrics at the same time. I decided I wanted to be able to view these lyrics wherever I was, and so began a new project.</p><p>The obvious choice would've been to just make an LRC file for the song and add it to LyrTube, but I had a few specific goals which ruled out this approach:</p><ul><li>I wanted to roughly imitate the style Tactical used for the lyrics. It's minimalism &amp; elegance suited the song.</li><li>I wanted to only display one line of lyrics at a time, to prevent reading ahead. I think this increases enjoyment of the flow of the song.</li><li>I wanted to synchronise every word, instead of every line. This was because the song is quite slow-paced, so every line would be a bit boring.</li><li>I wanted to display the original French lyrics and the English translation simultaneously.</li></ul><p>I had learned from my mistakes of aiming too big, so I decided that instead of trying to build a platform for lyrics I would just try to build a Single-Serving Site for this one song. This meant I was prioritising development speed over flexibility/maintainability. I challenged myself to develop the site as quickly as I could, preferably within 1 day.</p><h1 id="development-process" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Development process</h1><h2 id="planning" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Planning</h2><p>I still intended to use the LRC file format, but this time I'd be using the <a href="https://en.wikipedia.org/wiki/LRC_(file_format)#Enhanced_format">enhanced format</a> which supports per-word syncing.</p><p>I'd need to implement a way to include both French &amp; English lyrics. The uncommon <a href="https://en.wikipedia.org/wiki/LRC_(file_format)#Simple_format_extended">simple format extended</a> version of LRC supports multiple voices, but is quite limited. You can only tell the voices apart by gender (not language) and it's not designed for the voices to sing simultaneously. I decided instead to add a new (non-standard) tag to specify voices: <code>[voice:french]</code>.</p><p>Since one <em>line</em> in the song would now have multiple <em>lines</em> in the file (one for French and one for English) I decided to change the terminology a little to avoid ambiguity. A <em>line</em> in the song would now be referred to as a <em>card</em>, since all those words would be displayed fullscreen at once. "Line Time Tags" would now be called "Card Time Tags".</p><p>I decided not to use Canvas this time around for several reasons. Using Canvas meant I had to do a lot of text rendering myself. The original LyrTube didn't even support line wrapping, and this time I wanted to be sure my site would work on mobile devices. The web is a different place now to how it was in 2013, and mobile devices are now a very important consideration. By instead using DOM elements, the browser would do all the hard layout work for me.</p><p>I sketched out how the JavaScript would work. There would be four phases:</p><ol><li>Parsing - this would read the LRC file and translate it into a JavaScript object.</li><li>Rendering - this would read the JavaScript object and create DOM elements from it.</li><li>Layout - this would perform any expensive calculations about position and size, anything requiring a reflow. It would be re-run whenever the window was resized.</li><li>Draw - this would run every frame and update the positions/opacitites of all the elements.</li></ol><p>The planning didn't take very long, I only spent about 10 minutes on it.</p><h2 id="syncing" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Syncing</h2><p>To sync lyrics in the past I'd always used the simple tools provided by Lyrics Show Panel 3. These only support per-line syncing, but now I needed to sync each word. I decided I wasn't going to spend any time looking for other tools, I was going to stick with what I knew. So I needed to find a way to use this tool to do per-word syncing. Here's what I decided on:</p><ol><li>Write the lyrics in Notepad++ using Unix (LF) line endings.</li><li>Use find/replace to replace all newline characters '\n' with a colon and a space '; '. This is so we can remember where the line breaks are supposed to be.</li><li>Use find/replace to replace all spaces ' ' with newlines '\n'. Now every word is on its own line.</li><li>Convert line endings to Windows (CR LF) since this is what Lyrics Show Panel 3 understands. Copy/paste the lyrics into the Lyrics Show Panel 3 editor.</li><li>Synchronise the lyrics. Copy/paste the result back into Notepad++.</li><li>Convert line endings back to the superior Unix (LF) format.</li><li>Use find/replace to replace all '[' with '&lt;' and all ']' with '&gt;'. Also replace all newlines '\n' with spaces ' '. Now everything's a word instead of a line.</li><li>Use find/replace to replace any colon and space '; ' with a newline '\n'. Now all the line breaks are back.</li><li>Use a RegEx find/replace to add a Card Time Tag to the start of each line based on the first Word Time Tag on that line. For readability, the Card Time Tag can go on a different line to card's contents. Replace '<code>regex›\n&lt;(\d{2}\:\d{2}\.\d{2})&gt;</code>' with '<code>regex›\n[\1]\n&lt;\1&gt;</code>'.</li><li>Manually touch-up anything that doesn't quite look right.</li></ol><p>This worked perfectly, so now the only thing left to do was to add the translation. To do this I duplicated each line of lyrics, prefixing the original with <code>[voice:french]</code> and the copy with <code>[voice:english]</code>. Then I read through a translation of the lyrics and replaced the French words on the English line with English words, while preserving the word timing tags.</p><p>I spent about 1.5 hours between buying the song, downloading the song, syncing the lyrics, and adding the translation. </p><h2 id="parsing" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Parsing</h2><p>Initially I thought of modifying the LyrTube parsing code to handle Word Time Tags, but I quickly realised a problem with this approach. The old parsing code worked by splitting the lyrics file into lines and parsing each line separately, but now a single card might span multiple lines.</p><p>I don't really want to talk much about the parsing code since it's a hastily-written hack. It starts out fairly sane (feed the file character-by-character into a Finite State Machine) but then certain states of the FSM read characters on their own, which is pretty gross. If I was writing this again I would be consistent about every single character being fed to the FSM and the FSM not reading anything from the file itself.</p><p>But I managed to write the parsing algorithm in just a bit more than 2 hours, so from a development-speed perspective it was a success. (Or at least I was happy with it, since I really have no clue what I'm doing when it comes to parsing.)</p><h2 id="rendering" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Rendering</h2><p>The rendering algorithm is very straightforward, it just loops through the parsed object (henceforth called the Abstract Syntax Tree or AST) and creates DOM elements for everything.</p><p>But I committed another sin here: I took advantage of JavaScript's looseness and stored data on each created element. Card elements contain a reference to the card AST object, and word elements contain a reference to the word AST object. I stored a few other bits of miscellaneous data too. This data is used later on in the Draw phase. If I was writing this again, I would either mutate the AST to contain references to the elements, or I would have the render function output a new data structure which has references to both the elements and their corresponding AST objects.</p><p>This part took about 15 minutes.</p><h2 id="layout" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Layout</h2><p>The layout function serves a couple of purposes. The first is to make sure that on each card, all the voices are the same height. The lines might naturally be different heights if the text wraps in one language but doesn't in another, but this would cause the card to no longer look vertically centred. So the layout function unsets the height on each voice (allowing them to take their natural height), measures the height of each voice, then sets the height of all voices on the card to be the same as the height of the tallest voice.</p><p>The other purpose of the layout function is to measure the width of each voice and store it. This information is used to determine the width of the separator line that is displayed between voices.</p><p>Writing this function took about 15 minutes.</p><h2 id="draw" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Draw</h2><p>The draw function performs three main duties:</p><ol><li>Loop through every card and set their opacity, as well as determining whether they are (at least partially) visible.</li><li>Loop through the words on each visible card and set their position and opacity.</li><li>Loop through the separators on all visible cards and update their width.</li></ol><p>This is quite simple, but I spent quite a lot of time tweaking this to make sure everything looked as nice as possible. I spent about 2 hours in total on this part.</p><h1 id="results" class="heading-0-0-14"><span class="anchor-0-0-15" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Results</h1><p>And that was it, done! All-in-all it took slightly more than 6 hours. You can view the result <a href="http://sandbox.ymindustries.com/etoile-et-toi/">here</a>. It was fun to work on a small project with a tight timeline, I guess that's the appeal of hackathons.</p><p><img src="/blog.coding.joshwalsh/img/oneday-etoile.gif" alt="Result"></p><p>But that's not where the story ends. My timestamping itch hadn't been scratched, instead my passion for synchronised lyrics had been reignited. These two posts so far have just been providing background information for part 3 (coming soon to coding.blog, or you can read it in advance <a href="https://blog.joshwalsh.me">on my own blog</a>), where things get a little bit crazy.</p><hr><marker><br>

</marker><script id="xZO_PUsDxf">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("xZO_PUsDxf", "uU5Mf6hX80XLVyK7wxWrHg==", {"src":"github"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><script id="jJPLAgbxRJ">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("jJPLAgbxRJ", "Np8WqrudlIn6YtII/bgUUQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="contentnav-0-0-9" data-no-search=""><a href="#reincarnation" class="h1" data-content-highlight="reincarnation">Reincarnation</a><a href="#development-process" class="h1" data-content-highlight="development-process">Development process</a><a href="#planning" class="h2" data-content-highlight="planning">Planning</a><a href="#syncing" class="h2" data-content-highlight="syncing">Syncing</a><a href="#parsing" class="h2" data-content-highlight="parsing">Parsing</a><a href="#rendering" class="h2" data-content-highlight="rendering">Rendering</a><a href="#layout" class="h2" data-content-highlight="layout">Layout</a><a href="#draw" class="h2" data-content-highlight="draw">Draw</a><a href="#results" class="h1" data-content-highlight="results">Results</a></div></div><div id="-codedoc-toc" class="toc-0-0-6"><div class="content-0-0-7"><p><a href="/blog.coding.joshwalsh/">Home</a>
<a href="/blog.coding.joshwalsh/hilbert-shader">Making an animated Hilbert Curve using WebGL</a>
<a href="/blog.coding.joshwalsh/lyrics-1">Playing .lrc files in the browser</a>
<a href="/blog.coding.joshwalsh/lyrics-2">One-day build: Themed animated lyrics webapp</a></p><p><br><br></p></div></div><div class="footer-0-0-5"><div class="left"><script id="oUJBHlwzVA">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("oUJBHlwzVA", "Y37hGkTcTeOjIepkBSGIQg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="eedlYsctNS">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("eedlYsctNS", "++96ku066si1YE+LPC+GGg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="XrcFYqUhPs">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("XrcFYqUhPs", "YgUrfhgMTRkMOyJXSzrnNg==", {"namespace":"/blog.coding.joshwalsh"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>